<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>易云捷讯-企业云上易云</title>
<link href="/style/css.css" type="text/css" rel="stylesheet"/>
<link href="/style/style.css" type="text/css" rel="stylesheet"/>

<#assign name ="catalogTag">
<#assign catalogTag =newTag("${name}")>
</head>

<body>
<#include "/wwwroot/yymh/template/common/top.html">
<#include "/wwwroot/yymh/template/common/header.html">


<table width="1200" border="0" cellspacing="0" cellpadding="0" class="warp1200 paddingbt20">
	<tr>
    	<td>
		<h2 class="jiage_title">产品价格</h2>
        </td>
    </tr>
    <tr>
        <td width="212" valign="top" class="jiage_nav">
        	 <ul>
            	<#assign catalog=catalogTag("{'levels':'self','name':'402890e758434aaa01584368b45c00aa'}")>
    			<#if catalog?exists>
                	<li class="current"><span><a class="yzj_left" href="${catalog.url!'javascript:void(0);'}">云主机</a></span></li>
                </#if>
                <#assign catalog=catalogTag("{'levels':'self','name':'402890e758434aaa01584369eec500ae'}")>
    			<#if catalog?exists>
                	<li><span><a class="yyp_left" href="${catalog.url!'javascript:void(0);'}">云硬盘</a></span></li>
                </#if>
                <#assign catalog=catalogTag("{'levels':'self','name':'402890e758434aaa0158436c26ac00bc'}")>
    			<#if catalog?exists>
                	<li><span><a class="yypkz_left" href="${catalog.url!'javascript:void(0);'}">云硬盘快照</a></span></li>
                </#if>
                <#assign catalog=catalogTag("{'levels':'self','name':'402890e758434aaa0158436cbb8a00c0'}")>
    			<#if catalog?exists>
                	<li><span><a class="sywl_left" href="${catalog.url!'javascript:void(0);'}">私有网络</a></span></li>
                </#if>
                <!-- <#assign catalog=catalogTag("{'levels':'self','name':'402890e758434aaa0158436af1bc00b6'}")>
    			<#if catalog?exists>
                	<li><span><a class="fzjh_left" href="${catalog.url!'javascript:void(0);'}">负载均衡</a></span></li>
                </#if> -->
                <#assign catalog=catalogTag("{'levels':'self','name':'402890e758434aaa0158436a7d7c00b2'}")>
    			<#if catalog?exists>
                	<li><span><a class="txgw_left" href="${catalog.url!'javascript:void(0);'}">弹性公网IP</a></span></li>
                </#if>
                <!-- <#assign catalog=catalogTag("{'levels':'self','name':'402890e758434aaa0158436d49b400c4'}")>
    			<#if catalog?exists>
                	<li><span><a class="vpn_left" href="${catalog.url!'javascript:void(0);'}">VPN</a></span></li>
                </#if> -->
                <#assign catalog=catalogTag("{'levels':'self','name':'402890e758434aaa0158436b622b00ba'}")>
    			<#if catalog?exists>
                	<li><span><a class="dxcc_left" href="${catalog.url!'javascript:void(0);'}">对象存储</a></span></li>
                </#if>
            </ul>
		</td>
        <td width="676" valign="top" class="jiage_content">
        	<table width="100%" border="0" cellspacing="0" cellpadding="0">
            <form>
            	<div class="jiage_top">
                	<div class="jiage_top_title">
                		<span class="biaoti1">云主机</span>
                		<span class="jiage_price">￥<span class="sum">0</span></span>
                        <div class="clear"></div>
                    </div>
                    <div class="jiage_top_button clearfix">
                        <button type="button" class="cancel">取消更改</button>
                        <button type="button" class="save">保存</button>
                        <button type="button" class="last_button view">加入预览</button>
                    </div>
                </div>
                <div class="jiage_xinxi">
                	<h4>配置信息</h4>
                    <ul>
                    	<li class="data_center">
                        	<span class="jiage_label">数据中心:</span>
                        </li>
                    	<li>
                        	<span class="jiage_label">公网IP:</span>
                            <input type="checkbox" class="public_net"/>
                            <span>购买公网IP</span>
                        </li>
                    	<li>
                        	<span class="jiage_label">镜像操作系统:</span>
                            <div class="system">
                            </div>
                            <div class="system_select">
                            	<ul class="active">
                                </ul>
                            </div>
                        </li>
                        <div class="system_message">
                        	<div class="active">
                                <li class="cpu">
                                    <span class="jiage_label">CPU:</span>
                                </li>
                                <li class="storage">
                                    <span class="jiage_label">内存:</span>
                                </li>
                            </div>
                        </div>
                    </ul>
                	<h4>购买信息</h4>
                    <ul class="paddinglf30">
                    	<li class="purchase">
                            <span class="jiage_mark1 current" data-value="monthly">包年包月</span>
                            <span class="jiage_mark1" data-value="needed">按需付费</span>
                        </li>
                        <li>
                            <ul>
                                <li>
                                    <span class="jiage_label1">时间:</span>
                                    <div id="progress"></div>
                                    <div  class="progress"></div>月
                                    <div class="clear"></div>
                                </li>
                                <li id="purchase_number">
                                    <span class="jiage_label1">数量:</span>
                                    <span class="reduce">-</span>
                                    <input type="text" class="number anxu_number" />
                                    <span class="plus">+</span>
                                    <div class="clear"></div>
                                </li>
                            </ul>
                         </li>
                    </ul>
                </div>
            </form>
            </table>
		</td>
        <td width="10">&nbsp;</td>
        <td width="289" valign="top" class="jiage_view">
        	<div class="jiege_view_top">
            	<h4>价格预览</h4>
                <span>￥<span class="total_price">0</span></span>
            </div>
        </td>
    </tr>
</table>
<#include "/wwwroot/${sitePath}/template/common/foot_content.html">
<script type="text/javascript" src="/script/jquery.min.js"></script>
<script type="text/javascript" src="/script/header.js"></script>
<script type="text/javascript" src="/script/progress.js"></script>
<script type="text/javascript" src="/script/jquery.cookie.js"></script>
<script type="text/javascript" src="/script/priceModul.js"></script>
<script type="text/javascript">
    $(document).ready(function(e) {
        var price = new EayunPrice();
        function FormData (_data) {
            var data = _data || {
                dataCenter: 'bj',
                purchaseMessage:'bnby',
                publicNet: false,
                image: 'widowsStandard2012',
                mem: 'mem11',
                purchase: 'monthly',
                month: 1,
                number: 1,
                progressInput: 'input'
            };

            data.id = new Date().getTime();

            this.getData = function () {
                return data;
            }
        }

        function total(){
            var total = 0;
            for(i=0;i<$(".jiage_view_content").length;i++){
                var strLength = $(".jiage_view_content").eq(i).find(".edit_sum").text().length;
                total += parseFloat($(".jiage_view_content").eq(i).find(".edit_sum").text().substr(1, strLength));
            }
            $(".total_price").html(total.toFixed(3));
        };

        FormData.prototype.attr = function (attr,value) {
            var data = this.getData();

            if(value === undefined){
                return data[attr];
            }else{
                if(data.hasOwnProperty(attr)){
                    data[attr] = value;
                    $('.sum').text(this.getPrice());
                }
            }
        };

        FormData.prototype.getPrice = function(argument){
            var data = this.getData(),preview = price.getPrice(data);
            preview = data.purchase == 'monthly' ? preview * data.month : preview;
            return (preview*data.number).toFixed(3);

        };

        FormData.prototype.createView = function(){
            var template = '<ul class="jiage_view_content">'+
                            '<p>云主机<span class="edit_sum"></span><div class="clear"></div></p>'+
                            '<li class="edit_data"></li>'+
                            '<li class="edit_net"></li>'+
                            '<li class="edit_system"></li>'+
                            '<li class="edit_host"></li>'+
                            '<li class="edit_buy_message"></li>'+
                            '<li class="jiage_edit"><span class="edit"></span><span class="delete"></span></li>'+
                        '</ul>';
            var view = $(template),data = this.getData();
            view.attr('id','id'+data.id);
            view.find('.edit_sum').text('￥'+ this.getPrice());
            view.find('.edit_data').text('数据中心：'+ price.getDataCenterByCode(data.dataCenter).name);
            view.find('.edit_net').text('公网IP：'+ (data.publicNet?'已购买':'未购买'));
            view.find('.edit_system').text('镜像：'+ price.getImageByCode(data.image).name);
            view.find('.edit_host').text('主机规格：'+ price.getMemByCode(data.mem).type + '核' + price.getMemByCode(data.mem).name + 'GB');
            view.find('.edit_buy_message').text((data.purchase == 'monthly' ? data.month +'个月': '1小时' ) + 'x'+ data.number + '台');
            return view;
        };

        FormData.prototype.renderForm = function(){
            var data = this.getData(),that = this;

            function createSystem (dataCenterCode) {
                var os = price.getOSByDataCenterCode(dataCenterCode),
                    system = $('.system'),
                    image = price.getImageByCode(data.image);
                system.empty();
                $.each(os,function (index,element) {
                    var span = $('<span></span>');
                    span.addClass(element.type);
                    span.click(function () {
                        system.find('.active').removeClass('active');
                        span.addClass('active');
                        createSystemSelect(element.image);
                    });
                    system.append(span);
                    if(image.type == element.type){
                        span.click();
                    }
                });
            };

            function createSystemSelect (images) {
                var systemSelect = $('.system_select ul');
                systemSelect.empty();

                $.each(images,function (index,element) {
                    var li = $('<li></li>');
                    li.text(element.name);
                    li.attr('data-code',element.code);
                    li.click(function () {
                        systemSelect.find('.current').removeClass('current');
                        li.addClass('current');
                        that.attr('image',element.code);
                    });
                    systemSelect.append(li);
                    if(data.image == element.code){
                        li.click();
                    }

                });


                if(systemSelect.find('.current').length == 0){
                    systemSelect.find('li').first().click();
                }
            };

            function createCpu (dataCenterCode) {
                var cpu = price.getCpuByDataCenterCode(dataCenterCode),
                    cpuStorage = $('.cpu'),
                    mem = price.getMemByCode(data.mem);
                cpuStorage.find('.jiage_mark').remove();
                $.each(cpu,function (index,element) {
                    var span = $('<span  class="jiage_mark"></span>');
                        span.text(element.type+'核');
                    span.click(function () {
                        cpuStorage.find('.current').removeClass('current');
                        span.addClass('current');
                        createMem(element.mem);
                    });
                    cpuStorage.append(span);
                    if(mem.type == element.type){
                        span.click();
                    }
                });

                if(cpuStorage.find('.current').length == 0){
                    cpuStorage.find('.jiage_mark').first().click();
                }
            };

            function createMem (mems) {
                var storage = $('.storage');
                storage.find('.jiage_mark').remove();

                $.each(mems,function (index,element) {
                    var span = $('<span  class="jiage_mark"></span>');
                    span.text(element.name +'GB');
                    span.attr('data-code',element.code);
                    span.click(function () {
                        storage.find('.current').removeClass('current');
                        span.addClass('current');
                        that.attr('mem',element.code);
                    });
                    storage.append(span);
                    if(data.mem == element.code){
                        span.click();
                    }
                });

                if(storage.find('.current').length == 0){
                    storage.find('.jiage_mark').first().click();
                }
            };

            var dataCenterDom = $('.data_center'),
                dataCenter = price.getDataCenter();
            dataCenterDom.find('.jiage_mark').remove();
            $.each(dataCenter,function(index, element) {
                var span = $('<span class="jiage_mark"></span>');
                span.text(element.name);
                span.attr('data-code',element.code);
                span.click(function () {
                    dataCenterDom.find('.current').removeClass('current');
                    span.addClass('current');
                    that.attr('dataCenter',element.code);
                    createSystem(element.code);
                    createCpu(element.code);
                });
                dataCenterDom.append(span);
                if(element.code == data.dataCenter){
                    span.click();
                }
            });


            $('.system_select li').click(function(){
                if($(this).text()=='Windows sever2008 R2 标准版 64位中文版'){
                    $('.cpu span:last').hide();
                    if($('.storage span:last').text()=='64GB'){
                        $('.storage span:last').hide();
                    }
                    $('.cpu span').click(function(){
                        if($(this).text()=='16核'){
                           $('.storage span:last').hide();
                        }
                    })
                }else{
                    $('.cpu span:last').show();
                    $('.storage span:last').show(); 
                }
            });

            if(that.attr('publicNet')){
                $('.public_net').attr('checked','checked');
            }else{
                $('.public_net').removeAttr('checked','checked'); 
            }


            $('#purchase_number input').val(that.attr('number'));


            /*进度条*/
            var progress = $('#progress').progress({
                totalStep: 14,
                format:function(step){
                    if(step<12){
                        return step;
                    }else{
                        return ((step - 11)*12).toFixed(0);
                    }
                },
                parse:function(value){
                    if(value<12){
                        return value;
                    }else{
                        return value/12 + 11;
                    }
                },
                onChange: function(){
                    $('#progressText').val(progress.getValue());
                    that.attr('month',progress.getValue());
                }
            });
            progress.setValue(that.attr('month'));

            var progressDom = $('.progress'),
                progressInput = price.getProgressInput();
            progressDom.find('#progressText').remove();

            $.each(progressInput,function(index, element) {
                var input = $('<input class="time" type="text" id="progressText" />');
                input.attr('value',data.month);
                input.blur(function () {
                    progress.setValue(parseInt($('#progressText').val()));
                });
                progressDom.append(input);
            });

        };

        $('.public_net').click(function(){
            data.attr('publicNet',$(this).is(':checked'));
        });

        $('#purchase_number .reduce').click(function(){
            var number = parseInt($('#purchase_number input').val());
            number = number < 2 ? number : --number;
            $('#purchase_number input').val(number);
            data.attr('number',number);
        });

        $('#purchase_number .plus').click(function(){
            var number = parseInt($('#purchase_number input').val());
            number ++;
            $('#purchase_number input').val(number);
            data.attr('number',number);
        });

        $('#purchase_number input').blur(function(){
            data.attr('number',parseInt($(this).val()));
        });

        var data = new FormData(),dataArray = JSON.parse($.cookie("echview") || '[]');
        data.renderForm();

        $('.purchase span').click(function(){
            $('.purchase span').removeClass("current");
            $(this).addClass("current");
            var value = $(this).attr('data-value');
            data.attr('purchase',value);
            if(value == 'monthly'){
                $('#progress').parent().show();
            }else{
                $('#progress').parent().hide();
            }
            data.renderForm();
        });

        function editView(i){
            $('.save').show();
            $('.cancel').show();
            $('.view').hide();
            $(".edit").hide();
            $(".delete").hide();
            $(".jiage_view_content").eq(i).addClass("detail_edit");
            $(".jiage_view_content").eq(i).find(".edit").css("background-position","bottom left");

            if ($(".detail_edit").children(".edit_buy_message").text().indexOf("月")!=-1){
                $('.purchase span').removeClass("current");
                $('.purchase span').eq(0).addClass("current");
                $('#progress').parent().show();
            }else if($(".detail_edit").children(".edit_buy_message").text().indexOf("时")!=-1){
                $('#progress').parent().hide();
                $('.purchase span').removeClass("current");
                $('.purchase span').eq(1).addClass("current");
            }

            data = new FormData(dataArray[i]);
            data.renderForm();
            $.cookie("echview",JSON.stringify(dataArray));
        };

        function deleteView(i){
            dataArray.splice(i,1);
            $.cookie("echview",JSON.stringify(dataArray));
            drawView();
            total();
        };


        $(".view").click(function() {
            var view = data.createView(),i = dataArray.length;
            view.find('.edit').click(function () {
                editView(i);
            });
            view.find('.delete').click(function () {
                deleteView(i);
            });
            $('.jiage_view').append(view);
            dataArray.push(data.getData());
            data = new FormData($.extend({},data.getData()));
            data.renderForm();
            $.cookie("echview",JSON.stringify(dataArray));
            total();
        });



        $('.save').click(function(){
            $('.save').hide();
            $('.cancel').hide();
            $('.view').show();
            $(".edit").fadeIn();
            $(".delete").fadeIn();
            $(".jiage_view_content").removeClass("detail_edit");
            $(".jiage_view_content .edit").fadeIn().css("background-position","top left");
            $('#progress').parent().show();
            $.cookie("echview",JSON.stringify(dataArray));
            data = new FormData();
            data.renderForm();
            
            $('.purchase span').removeClass("current");
            $('.purchase span').eq(0).addClass("current");
            drawView();
            total();
        });

        $('.cancel').click(function(){
            $('.save').hide();
            $('.cancel').hide();
            $('.view').show();
            $(".delete").fadeIn();
            $(".jiage_view_content").removeClass("detail_edit");
            $(".edit").fadeIn().css("background-position","top left");
            $('#progress').parent().show();
            dataArray = JSON.parse($.cookie("echview") || '[]');
            data = new FormData();
            data.renderForm();
            
            $('.purchase span').removeClass("current");
            $('.purchase span').eq(0).addClass("current");
        });

        function drawView(){
            $('.jiage_view .jiage_view_content').remove();
            $.each(dataArray,function (index,element) {
                var _data = new FormData(element),
                        view = _data.createView()
                view.find('.edit').click(function () {
                    editView(index);
                });
                view.find('.delete').click(function () {
                    deleteView(index);
                });
                $('.jiage_view').append(view);
            });
        };

        $("input").keyup(function(e) {
            this.value=this.value.replace(/[^\d]/g,'');
            if ($(this).val()==''){
                $(this).val(0);
            }
        });

        drawView();
        total();
    });
</script>
</body>
</html>
